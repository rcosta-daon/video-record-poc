<!-- enumerateDevices only works in secure contexts (HTTPS) -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video recording POC</title>
    <style>
      body {
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h2>V7</h2>

    <h3>Devices</h3>
    <div id="devices-container"></div>

    <h3>Camera</h3>
    <video id="camera" playsinline autoplay muted></video>

    <h3>Record</h3>
    <label for="duration">Duration: </label>
    <input type="number" id="duration" name="duration" />
    <br />
    <button id="record">Record</button>

    <script type="module">
      async function requestPermission() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach((track) => track.stop());
      }

      async function getDevices() {
        const devicesInfo = await navigator.mediaDevices.enumerateDevices();
        const videoDevicesInfo = devicesInfo.filter(({ kind }) => kind === "videoinput");
        const devices = [];

        for (const videoDeviceInfo of videoDevicesInfo) {
          const deviceId = videoDeviceInfo.deviceId;
          const label = videoDeviceInfo.label;

          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { deviceId: { exact: deviceId } },
            });

            const tracks = stream.getVideoTracks();
            const settings = tracks.map((track) => track.getSettings());
            const spec = settings
              .map((settings) => `${settings.width}x${settings.height}@${settings.frameRate}hz`)
              .join(" ");

            devices.push({ deviceId, spec, label });

            for (const track of tracks) {
              track.stop();
            }
          } catch (error) {
            devices.push({ deviceId, label });
          }
        }

        return devices;
      }

      await requestPermission();

      const devicesContainer = document.getElementById("devices-container");
      const camera = document.getElementById("camera");
      const radios = [];

      for (const device of await getDevices()) {
        if (device.spec) {
          const radio = document.createElement("input");
          radio.type = "radio";
          radio.id = device.deviceId;
          radio.name = device.deviceId;
          radio.addEventListener("click", async () => {
            for (const radio of radios) {
              radio.checked = false;
            }
            radio.checked = true;
            camera.srcObject = await navigator.mediaDevices.getUserMedia({
              video: { deviceId: { exact: device.deviceId } },
            });
          });
          radios.push(radio);
          const label = document.createElement("label");
          label.htmlFor = device.deviceId;
          label.textContent = `${device.label} ${device.spec}`;

          devicesContainer.appendChild(radio);
          devicesContainer.appendChild(label);
          devicesContainer.appendChild(document.createElement("br"));
        } else {
          const p = document.createElement("p");
          p.textContent = `${device.label} (failed)`;
          devicesContainer.appendChild(p);
          devicesContainer.appendChild(document.createElement("br"));
        }
      }

      let duration;
      const durationInput = document.getElementById("duration");
      durationInput.value = String(duration);
      durationInput.addEventListener("change", () => {
        duration = Number(durationInput.value);
      });

      const record = document.getElementById("record");
      record.addEventListener("click", () => {
        record.disabled = true;
        setTimeout(() => {
          record.disabled = false;
        }, duration);
      });
    </script>
  </body>
</html>
