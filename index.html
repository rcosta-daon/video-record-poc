<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video recording POC</title>
    <style>
      body {
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h2>V2</h2>

    <h3>Devices</h3>
    <div id="devices-container"></div>

    <h3>Camera</h3>
    <video id="camera"></video>

    <h3>Record</h3>
    <label for="duration">Duration: </label>
    <input type="number" id="duration" name="duration" />
    <br />
    <button id="record">Record</button>

    <script type="module">
      (await navigator.mediaDevices.getUserMedia({ video: true })).getTracks().forEach((track) => track.stop());

      const allDevices = await navigator.mediaDevices.enumerateDevices();
      const devices = allDevices.filter(({ kind }) => kind === "videoinput");

      const camera = document.getElementById("camera");
      const radios = [];
      for (const device of [devices.slice[0]]) {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: device.deviceId } },
        });
        const tracks = stream.getVideoTracks();
        const spec = tracks
          .map((track) => {
            const settings = track.getSettings();
            return `${settings.width}x${settings.height}@${settings.frameRate}hz`;
          })
          .join(" ");

        const radio = document.createElement("input");
        radio.type = "radio";
        radio.id = device.deviceId;
        radio.name = device.deviceId;
        radio.addEventListener("click", async () => {
          for (const radio of radios) {
            radio.checked = false;
          }
          radio.checked = true;
          camera.srcObject = await navigator.mediaDevices.getUserMedia({
            video: { deviceId: { exact: device.deviceId } },
          });
        });
        radios.push(radio);
        const label = document.createElement("label");
        label.htmlFor = device.deviceId;
        label.textContent = `${device.label} ${spec}`;

        const devicesContainer = document.getElementById("devices-container");
        devicesContainer.appendChild(radio);
        devicesContainer.appendChild(label);
        devicesContainer.appendChild(document.createElement("br"));

        for (const track of tracks) {
          track.stop();
        }

        await new Promise((resolve) => setTimeout(resolve, 100));
      }
    </script>
  </body>
</html>
